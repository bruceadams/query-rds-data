env:
  BASENAME: query-rds-data
  GITHUB_TOKEN: ENCRYPTED[2daeddfc1e5f9979684f4f15e8c937e43722a18454bb2ed21b678784ad779413df9a0bd110d1d02eb0dce622be7d8108]

macos_universal_task:
  macos_instance:
    image: big-sur-xcode
  env:
    RUST_HOME: $HOME/macos
    CARGO_HOME: $RUST_HOME/cargo
    RUSTUP_HOME: $RUST_HOME/rustup
    PATH: $CARGO_HOME/bin:$PATH
  rust_cache:
    folder: $RUST_HOME
    reupload_on_changes: true
    fingerprint_script:
      - echo $CIRRUS_OS
      - date +%Y
    populate_script: >
      curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs |
      sh -s -- -y --verbose --no-modify-path --target aarch64-apple-darwin
  update_script: rustup --verbose update
  target_cache:
    folder: target
    reupload_on_changes: true
    fingerprint_script:
      - echo $CIRRUS_OS
      - rustc --version
  build_script:
    - cargo build --verbose --release --target aarch64-apple-darwin
    - mv target/aarch64-apple-darwin/release/$BASENAME $BASENAME.macos.aarch64
    - cargo build --verbose --release --target x86_64-apple-darwin
    - mv target/x86_64-apple-darwin/release/$BASENAME $BASENAME.macos.x86_64
    - lipo -create -output $BASENAME.macos.universal $BASENAME.macos.aarch64 $BASENAME.macos.x86_64
    - file $BASENAME.macos.universal
  binary_artifacts:
    path: $BASENAME.macos.*
  release_script: ./upload-binary.sh $BASENAME.macos.*
  before_cache_script: rm -f target/.rustc_info.json

linux_x68_64_task:
  container:
    image: rust:latest
  registry_cache:
    folder: $CARGO_HOME/registry
    reupload_on_changes: true
    fingerprint_script: date +%Y
  target_cache:
    folder: target
    reupload_on_changes: true
    fingerprint_script:
      - echo $CIRRUS_OS
      - rustc --version
  build_script:
    - cargo build --verbose --release
    - mv target/release/$BASENAME $BASENAME.$CIRRUS_OS.x86_64
    - file $BASENAME.$CIRRUS_OS.x86_64
    - ldd $BASENAME.$CIRRUS_OS.x86_64
  binary_artifacts:
    path: $BASENAME.$CIRRUS_OS.*
  release_script: ./upload-binary.sh $BASENAME.$CIRRUS_OS.*
  before_cache_script: rm -f target/.rustc_info.json

linux_arm_task:
  arm_container:
    image: rust:latest
  registry_cache:
    folder: $CARGO_HOME/registry
    reupload_on_changes: true
    fingerprint_script: date +%Y
  target_cache:
    folder: target
    reupload_on_changes: true
    fingerprint_script:
      - echo $CIRRUS_OS
      - rustc --version
  build_script:
    - cargo build --verbose --release
    - mv target/release/$BASENAME $BASENAME.$CIRRUS_OS.aarch64
    - file $BASENAME.$CIRRUS_OS.aarch64
    - ldd $BASENAME.$CIRRUS_OS.aarch64
  binary_artifacts:
    path: $BASENAME.$CIRRUS_OS.*
  release_script: ./upload-binary.sh $BASENAME.$CIRRUS_OS.*
  before_cache_script: rm -f target/.rustc_info.json

freebsd_x86_task:
  freebsd_instance:
    image_family: freebsd-13-0
  env:
    RUST_HOME: $HOME/freebsd
    CARGO_HOME: $RUST_HOME/cargo
    RUSTUP_HOME: $RUST_HOME/rustup
    PATH: $CARGO_HOME/bin:$PATH
  rust_cache:
    folder: $RUST_HOME
    reupload_on_changes: true
    fingerprint_script:
      - echo $CIRRUS_OS
      - date +%Y
    populate_script: >
      curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs |
      sh -s -- -y --verbose --no-modify-path
  update_script: rustup --verbose update
  target_cache:
    folder: target
    reupload_on_changes: true
    fingerprint_script:
      - echo $CIRRUS_OS
      - rustc --version
  build_script:
    - cargo build --verbose --release
    - mv target/release/$BASENAME $BASENAME.$CIRRUS_OS.x86_64
    - file $BASENAME.$CIRRUS_OS.x86_64
  binary_artifacts:
    path: $BASENAME.$CIRRUS_OS.*
  release_script: ./upload-binary.sh $BASENAME.$CIRRUS_OS.*
  before_cache_script: rm -f target/.rustc_info.json

windows_x86_task:
  windows_container:
    image: cirrusci/windowsservercore:2019
  env:
    RUST_HOME: C:\Users\ContainerAdministrator\rust
    CARGO_HOME: $RUST_HOME\cargo
    RUSTUP_HOME: $RUST_HOME\rustup
    PATH: $CARGO_HOME\bin;$PATH
  vs_cpp_script:
    - curl -fSLo vs_buildtools.exe https://aka.ms/vs/16/release/vs_buildtools.exe
    - >
      vs_buildtools.exe --quiet --wait --norestart --nocache
      --installPath C:\BuildTools
      --add Microsoft.Component.MSBuild
      --add Microsoft.VisualStudio.Component.Windows10SDK.18362
      --add Microsoft.VisualStudio.Component.VC.Tools.x86.x64
  rust_cache:
    folder: $RUST_HOME
    reupload_on_changes: true
    fingerprint_script:
      - echo %CIRRUS_OS%
      - date /t
    populate_script:
      - curl -fSLo rustup-init.exe https://win.rustup.rs/x86_64
      - rustup-init.exe -y --verbose
      - del rustup-init.exe
  update_script:
    - rustup --verbose update
  target_cache:
    folder: target
    reupload_on_changes: true
    fingerprint_script:
      - echo %CIRRUS_OS%
      - rustc --version
  build_script:
    - cargo build --verbose --release --target x86_64-pc-windows-msvc
    - move target\x86_64-pc-windows-msvc\release\%BASENAME%.exe %BASENAME%.%CIRRUS_OS%.x86_64.exe
  binary_artifacts:
    path: $BASENAME.$CIRRUS_OS.*
  before_cache_script: del target\.rustc_info.json
